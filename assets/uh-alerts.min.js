/**
 * University of Hawaiʻi Emergency Alerts
 * Copyright 2018 University of Hawaiʻi
 * @license GPL2
 */
!function(e,t,s){"use strict";function r(t,s){d.debug&&e.console&&e.console.log&&(s?e.console.log("UH Alerts:",t,s):e.console.log("UH Alerts:",t))}function a(e){return parseInt(e,10)}function n(e){var t=e.split(" ")[0].split("-"),s=e.split(" ")[1].split(":"),r=new Date(a(t[0]),a(t[1])-1,a(t[2]),a(s[0]),a(s[1]),a(s[2])),n=Math.round((+new Date-r)/1e3),i=3600,o=24*i;return 30>n?"moments ago":60>n?n+" seconds ago":120>n?"a minute ago":i>n?Math.floor(n/60)+" minutes ago":1===Math.floor(n/i)?"1 hour ago.":o>n?Math.floor(n/i)+" hours ago":2*o>n?"yesterday":Math.floor(n/o)+" days ago"}function i(){var e,t=new XMLHttpRequest;r("getAlerts()"),t.open("GET",d.api_url+"/alerts/"+d.region,!0),t.onreadystatechange=function(){var s="";if(4===t.readyState)if(200===t.status)if(u!==t.response){if((e=JSON.parse(t.response))&&e.length){r("got "+e.length+" alerts"),s="";for(var a=0;a<e.length;a++){var i=e[a];d.alert_info_url?s+='<p><a href="'+d.alert_info_url+i.id+'">'+i.title+"</a>: "+i.sms_message+' <span class="uh-alerts-updated">(Updated '+n(i.updated_at||i.created_at)+")</span></p>":s+="<p><strong>"+i.title+"</strong>: "+i.sms_message+' <span class="uh-alerts-updated">(Updated '+n(i.updated_at||i.created_at)+")</span></p>"}c.innerHTML=s,f.show()}else r("no alerts"),c.innerHTML="",f.hide();u=t.response}else r("new data same as cached");else r("fetch failed with status "+t.status)},t.setRequestHeader("Content-Type","application/json; charset=utf-8"),t.send()}function o(e){e.target&&e.target.classList.contains("uh-alerts-hide")&&(r("hide button tapped"),e.preventDefault(),e.stopPropagation(),f.hide())}function l(e){"Escape"===e.key&&isOpen()&&(r("hiding via escape key"),f.hide())}if(e.XMLHttpRequest&&"classList"in t.documentElement&&t.querySelector&&t.addEventListener){var d,u,p,c,h,f={},g="querySelector"in t&&"addEventListener"in e&&"classList"in t.createElement("_"),m={alert_info_url:"",api_url:"",classes:"",debug:!1,element_id:"uh-alerts",refresh_rate:0,region:"",wrapper_id:"uh-alerts-wrapper"},v=!1;f.isOpen=function(){return p.classList.contains("uh-alerts-active")},f.show=function(){r("show()"),!f.isOpen()&&p.classList.add("uh-alerts-active")},f.hide=function(){r("hide()"),f.isOpen()&&p.classList.remove("uh-alerts-active")},f.destroy=function(){d&&(r("destroy()"),t.documentElement.classList.remove("UHAlerts"),p&&p.removeEventListener("click",o),e.removeEventListener("keypress",o),clearTimeout(h),d=null)},f.init=function(s){if(g){f.destroy(),d={};for(var a in m)m.hasOwnProperty(a)&&(d[a]=m[a]);for(var a in s)s.hasOwnProperty(a)&&(d[a]=s[a]);if(!d.region||!d.api_url)return void r("missing region and/or api_url...aborting.");if(r(d),p=t.getElementById(d.wrapper_id))r("using existing wrapper");else{r("creating wrapper"),p=t.createElement("div"),p.id=d.wrapper_id,p.className="uh-alerts-wrapper",p.setAttribute("role","alert");var n=t.createElement("div");n.innerHTML='<p class="uh-alerts-hide-wrapper"><button class="uh-alerts-hide">Hide</button></p>',c=t.createElement("div"),c.className="uh-alerts-alerts",c.id=d.element_id,n.appendChild(c),p.appendChild(n),t.body.insertBefore(p,t.body.firstElementChild)}d.classes&&p.classList.add(d.classes),i(),d.refresh_rate>0&&(v=!0,h=setInterval(i,1e3*d.refresh_rate)),p.addEventListener("click",o,!1),e.addEventListener("keypress",l,!1)}},f.pause=function(){r("pause()"),v?(r("paused updates"),v=!1,clearInterval(h)):r("not running")},f.resume=function(){r("resume()"),d.refresh_rate?(r("resuming updates every "+d.refresh_rate+" seconds"),v=!0,i(),h=setInterval(i,1e3*d.refresh_rate)):r("no refresh rate to resume")},e.UHAlerts=f}}(window,document);